#!/bin/bash

# Claude Code User Prompt Submit Hook
# Routes user prompts to appropriate specialist agents

set -e

USER_PROMPT="$1"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
PROJECT_ROOT="/home/coder/convex-coder"

cd "$PROJECT_ROOT"

# Log all user prompts for analysis
echo "[$TIMESTAMP] User prompt: $USER_PROMPT" >> .claude/session.log

# Agent command detection with CORRECT agent names
detect_agent_commands() {
    local prompt="$1"
    
    # Command-based routing (highest priority)
    if [[ "$prompt" =~ @feature-complete ]]; then
        echo "Orchestrator"  # Feature-complete uses Orchestrator to coordinate
    elif [[ "$prompt" =~ @agent-orchestrate ]]; then
        echo "Orchestrator"
    elif [[ "$prompt" =~ @test-comprehensive ]]; then
        echo "Web Testing Specialist"
    elif [[ "$prompt" =~ @health-check|@performance ]]; then
        echo "Performance Engineer"
    elif [[ "$prompt" =~ @visual-regression ]]; then
        echo "Web Testing Specialist"
        
    # Context-based routing (when no explicit command)
    elif [[ "$prompt" =~ "orchestrate"|"coordinate"|"epic"|"multiple features" ]]; then
        echo "Orchestrator"
    elif [[ "$prompt" =~ "implement feature"|"create feature"|"build feature" ]] && \
         [[ "$prompt" =~ "simple"|"basic"|"small"|"quick" ]]; then
        echo "Fullstack Feature Creator"  # For simple features
    elif [[ "$prompt" =~ "schema"|"database"|"table"|"index"|"migration" ]]; then
        echo "Convex Schema Manager"
    elif [[ "$prompt" =~ "component"|"react"|"ui"|"frontend"|"interface" ]]; then
        echo "React Convex Builder"
    elif [[ "$prompt" =~ "query"|"mutation"|"action"|"function"|"backend"|"api" ]]; then
        echo "Convex Function Generator"
    elif [[ "$prompt" =~ "auth"|"login"|"oauth"|"permission"|"role"|"security" ]]; then
        echo "Convex Auth Specialist"
    elif [[ "$prompt" =~ "test"|"playwright"|"e2e"|"visual"|"regression" ]]; then
        echo "Web Testing Specialist"
    elif [[ "$prompt" =~ "performance"|"optimization"|"speed"|"bundle"|"slow" ]]; then
        echo "Performance Engineer"
    fi
}

# Extract task description from prompt
extract_task_description() {
    local prompt="$1"
    
    # Remove agent commands and common prefixes
    local cleaned=$(echo "$prompt" | sed -E 's/@[a-z-]+//g' | sed -E 's/^(please|can you|help me|I need|implement|create|add|fix|update)//i' | xargs)
    
    # Limit length for context storage
    if [[ ${#cleaned} -gt 100 ]]; then
        cleaned="${cleaned:0:97}..."
    fi
    
    echo "$cleaned"
}

# Start agent session if agent work is detected
DETECTED_AGENT=$(detect_agent_commands "$USER_PROMPT")

if [[ -n "$DETECTED_AGENT" ]]; then
    TASK_DESC=$(extract_task_description "$USER_PROMPT")
    
    echo "ü§ñ Routing to: $DETECTED_AGENT"
    echo "üìã Task: $TASK_DESC"
    
    # Agent coordination guidance
    case "$DETECTED_AGENT" in
        "Orchestrator")
            echo "üí° Orchestrator will coordinate specialist agents:"
            echo "   ‚Ä¢ Convex Schema Manager (schema design)"
            echo "   ‚Ä¢ Convex Function Generator (backend)"
            echo "   ‚Ä¢ React Convex Builder (frontend)"
            echo "   ‚Ä¢ Convex Auth Specialist (auth if needed)"
            echo "   ‚Ä¢ Web Testing Specialist (testing)"
            echo "   ‚Ä¢ Performance Engineer (optimization)"
            ;;
        "Fullstack Feature Creator")
            echo "üí° Full-stack agent will implement the complete feature"
            ;;
        "Web Testing Specialist")
            echo "üí° Testing specialist will run comprehensive test suite"
            ;;
        "Performance Engineer")
            echo "üí° Performance engineer will optimize and monitor"
            ;;
        *)
            echo "üí° Specialist agent will handle: $DETECTED_AGENT"
            ;;
    esac
    
    # Start agent session
    if ./scripts/update-context.sh "$DETECTED_AGENT" session-start "$TASK_DESC" 2>/dev/null; then
        echo "‚úÖ Started session for $DETECTED_AGENT"
        
        # Store current agent for other hooks
        echo "$DETECTED_AGENT" > .claude/current-agent
        echo "$TASK_DESC" > .claude/current-task
    else
        echo "‚ö†Ô∏è  Could not start session for $DETECTED_AGENT"
    fi
fi

# Special handling for testing requests
if [[ "$USER_PROMPT" =~ "test"|"playwright"|"visual regression" ]]; then
    # Ensure Playwright is available
    if ! command -v npx >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  Testing tools may not be available - npx not found"
    fi
    
    # Check if test infrastructure exists
    if [[ ! -f "playwright.config.ts" && ! -f "playwright.config.js" ]]; then
        echo "üí° Hint: Playwright config not found - Web Testing Specialist can set it up"
    fi
fi

# Context awareness - check if continuing previous work
if [[ -f ".claude/current-agent" ]]; then
    CURRENT_AGENT=$(cat .claude/current-agent 2>/dev/null || echo "")
    if [[ -n "$CURRENT_AGENT" && -z "$DETECTED_AGENT" ]]; then
        # Continuing work with same agent
        if [[ "$USER_PROMPT" =~ "continue"|"next"|"also"|"additionally"|"now" ]]; then
            echo "üîÑ Continuing work with: $CURRENT_AGENT"
            TASK_DESC=$(extract_task_description "$USER_PROMPT")
            ./scripts/update-context.sh "$CURRENT_AGENT" add-learning "User requested: $TASK_DESC" 2>/dev/null || true
        fi
    fi
fi

# Development environment checks
check_dev_environment() {
    local warnings=()
    
    # Check if Convex is running
    if ! pgrep -f "convex dev" >/dev/null; then
        warnings+=("Convex dev server may not be running")
    fi
    
    # Check for environment configuration
    if [[ ! -f ".env" && ! -f ".env.local" ]]; then
        warnings+=("Environment configuration may be missing")
    fi
    
    # Report warnings
    for warning in "${warnings[@]}"; do
        echo "‚ö†Ô∏è  $warning"
    done
}

# Check environment for development prompts
if [[ "$USER_PROMPT" =~ "dev"|"development"|"run"|"start"|"build" ]]; then
    check_dev_environment
fi

# Exit successfully to allow prompt to proceed
exit 0