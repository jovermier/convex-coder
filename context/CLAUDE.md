# Convex Coder Development Environment

## Project Overview

This is a Convex development workspace running in a Coder environment, configured for full-stack TypeScript development with self-hosted Convex backend integration. The workspace provides automated infrastructure provisioning including PostgreSQL databases and S3 storage, all seamlessly integrated with Convex.

## Key Project Files & Documentation

### Core Configuration

- **`package.json`**: Node.js project configuration with Convex dependencies and development scripts
- **`convex.json`**: Convex project configuration specifying functions directory and deployment settings
- **`docker-compose.yml`**: Self-hosted Convex backend orchestration with workspace database/storage integration
- **`vite.config.mts`**: Vite build configuration for React frontend development
- **`tailwind.config.js`**: Tailwind CSS configuration for styling

### Environment Configuration

- **`.env`**: Primary environment file with Convex backend URLs and workspace configuration _(in /home/coder/repo)_
- **`.env.docker`**: Docker services environment variables _(in /home/coder/repo)_
- **`.env.local`**: Frontend-specific environment variables _(in /home/coder/repo)_
- **`CONVEX_ENVIRONMENT_VARIABLES.md`**: Reference documentation for Convex backend configuration options (not project-specific variables)

### Convex Functions & Schema

- **`convex/`**: Convex functions directory
  - **`schema.ts`**: Database schema definitions with type safety
  - **`chat.ts`**: Chat functionality with real-time messaging
  - **`uploads.ts`**: File upload handling with storage integration
  - **`_generated/`**: Auto-generated API types and definitions

### React Frontend

- **`src/App.tsx`**: Main React application component
- **`src/components/chat/`**: Chat interface components with real-time updates
- **`src/hooks/`**: Custom React hooks for Convex integration and data fetching
- **`src/components/ui/`**: Reusable UI components built with Shadcn/ui

### Documentation & Analysis

- **`CONVEX_ENVIRONMENT_SUMMARY.md`**: Environment setup and configuration documentation
- **`CONVEX_CODER_TEMPLATE_ANALYSIS.md`**: Comprehensive review of the Coder workspace template implementation
- **`CONVEX_FILE_UPLOAD_SUMMARY.md`**: Detailed analysis of file upload configuration and S3 compatibility issues
- **`CONVEX_SELF_HOSTED_RESEARCH.md`**: Comprehensive research on fully self-hosting Convex with complete cloud feature parity

### Reference Materials

- **`references/`**: External documentation and templates
  - **`coder-templates/convex/`**: Complete Coder workspace template with Terraform infrastructure
  - **`convex-backend/`**: Convex backend source code and documentation
  - **`convex-codespaces/`**: GitHub Codespaces configuration examples

## Current Configuration Status

###  Working Systems

- **Self-hosted Convex Backend**: Running on port 3210 with workspace PostgreSQL integration
- **Convex Dashboard**: Available on port 6791 with correct workspace URL configuration
- **File Storage**: Local file storage configured (S3 compatibility issues resolved)
- **React Frontend**: Vite development server on port 5173
- **Database**: PostgreSQL with automatic credential injection
- **Development Tools**: VS Code, Claude Code, Docker-in-Docker capability

### =' Development Workflow

```bash
# Start development servers
pnpm dev                    # Frontend (port 5173)

# Docker services (self-hosted Convex)
docker-compose up -d        # Start backend + dashboard
docker-compose logs         # View service logs
docker-compose down         # Stop services
docker-compose restart backend  # Pick up function changes
```

### =ï¿½ Service Access Points

- **Frontend App**: http://localhost:5173 (Vite)
- **Convex Backend**: http://localhost:3210 (API)
- **Convex Dashboard**: http://localhost:6791 (Admin interface)
- **VS Code**: Available through Coder workspace apps

## Environment Integration

### Automatic Workspace Integration

This workspace automatically configures:

- **PostgreSQL**: Dedicated database per workspace with auto-generated credentials
- **S3 Storage**: Workspace-specific buckets with unique access keys
- **Environment Variables**: Seamless injection into Convex backend services
- **Port Forwarding**: All development ports pre-configured in Coder

### Workspace Environment Variables

The Coder workspace automatically injects these environment variables:

```bash
# PostgreSQL Database (auto-injected by workspace)
PGHOST="<workspace-db-host>"              # Database server hostname
PGPORT="5432"                             # Database port
PGDATABASE="app"                          # Database name
PGUSER="app"                              # Database username
PGPASSWORD="<auto-generated>"             # Database password
PGURI="postgresql://app:<password>@<host>:5432/app"  # Full connection string
PGJDBCURI="jdbc:postgresql://<host>:5432/app"        # JDBC connection string

# Rook Ceph S3 Storage (auto-configured by workspace)
S3_REGION="us-central-1"                  # S3 region
S3_ENDPOINT="https://s3.us-central-1.hahomelabs.com"  # S3 endpoint URL
S3_ACCESS_KEY="<workspace-specific>"      # S3 access key (unique per workspace)
S3_SECRET_KEY="<workspace-specific>"      # S3 secret key (unique per workspace)
S3_BUCKET_NAME="workspace-<owner>-<name>-<id>"       # Workspace-specific bucket

# Database Backup Storage (separate bucket for PostgreSQL backups)
DB_BACKUP_BUCKET_NAME="workspace-cnpg-<owner>-<name>-<id>"
DB_BACKUP_ACCESS_KEY="<backup-specific>"
DB_BACKUP_SECRET_KEY="<backup-specific>"
DB_SERVER_NAME="<owner>-<name>-db-<id>-0"

# Workspace Identity
CODER_WORKSPACE_NAME="<workspace-name>"   # Current workspace name
CODER_WORKSPACE_ID="<workspace-id>"       # Unique workspace identifier
CODER_WORKSPACE_OWNER_NAME="<username>"   # Workspace owner username

# Convex URLs (workspace-specific)
NEXT_PUBLIC_DEPLOYMENT_URL="https://convex-api--main--<workspace>--<owner>.coder.hahomelabs.com"
```

### How These Variables Are Used

- **PostgreSQL variables**: Automatically injected into Convex backend for database connectivity
- **S3 variables**: Used by Convex backend for file storage (currently configured for local storage)
- **Workspace identity**: Used for resource naming and isolation
- **Convex URLs**: Used by dashboard and frontend to connect to the correct backend instance

## Development Tips

### Working with Convex Functions

- Functions in `convex/` directory are automatically available to the self-hosted backend
- Function changes require backend restart: `docker-compose restart backend`
- Database schema changes are picked up automatically on backend restart

### File Uploads

- Currently configured for local storage (S3 compatibility resolved)
- Upload functionality available through dashboard
- Storage location: Docker volume `data:/convex/data`

### Troubleshooting Common Issues

1. **Dashboard URL Issues**: Ensure docker-compose dashboard service has `env_file: - .env` directive
2. **Port Conflicts**: Check if services are already running on required ports
3. **Environment Variables**: Verify `.env` files are properly loaded by services

## Quick Start Commands

```bash
# View running services
docker-compose ps

# Check logs for troubleshooting
docker-compose logs backend
docker-compose logs dashboard

# Restart services after config changes
docker-compose restart

# Access database directly
psql $PGURI

# View frontend development server
curl http://localhost:5173
```

For detailed implementation analysis, see the comprehensive documentation files listed above.
