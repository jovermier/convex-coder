# Convex Environment Setup and Configuration Summary

## Overview
This document summarizes the environment setup and configuration for the Convex self-hosted development workspace, including how environment variables flow between different services and components.

## Environment File Structure

### File Hierarchy and Purpose
1. **`.env`** (in `/home/coder/repo/`): Primary environment file read by Docker Compose services
2. **`.env.docker`** (in `/home/coder/repo/`): Backend-specific environment variables  
3. **`.env.local`** (in `/home/coder/repo/`): Frontend React application environment variables

### Docker Compose Environment Loading
- **Backend service**: Reads `.env` file via `env_file: - .env` directive
- **Dashboard service**: Reads `.env` file via `env_file: - .env` directive (fixed in recent update)
- **Environment precedence**: `environment:` section overrides `env_file` variables

## Workspace-Provided Environment Variables

### Automatic Injection by Coder Workspace
The following environment variables are automatically provided by the Coder workspace infrastructure:

#### PostgreSQL Database
```bash
PGHOST="<workspace-db-hostname>"
PGPORT="5432"  
PGDATABASE="app"
PGUSER="app"
PGPASSWORD="<auto-generated-password>"
PGURI="postgresql://app:<password>@<host>:5432/app"
PGJDBCURI="jdbc:postgresql://<host>:5432/app"
```

#### Rook Ceph S3 Storage  
```bash
S3_REGION="us-central-1"
S3_ENDPOINT="https://s3.us-central-1.hahomelabs.com"
S3_ACCESS_KEY="<workspace-unique-access-key>"
S3_SECRET_KEY="<workspace-unique-secret-key>"
S3_BUCKET_NAME="workspace-<owner>-<workspace>-<short-id>"
S3_WORKSPACE_BUCKET_NAME="workspace-<owner>-<workspace>-<short-id>"
```

#### Database Backup Storage
```bash
DB_BACKUP_BUCKET_NAME="workspace-cnpg-<owner>-<workspace>-<short-id>"
DB_BACKUP_ACCESS_KEY="<backup-specific-access-key>"
DB_BACKUP_SECRET_KEY="<backup-specific-secret-key>"
DB_SERVER_NAME="<owner>-<workspace>-db-<short-id>-0"
```

#### Workspace Identity
```bash
CODER_WORKSPACE_NAME="<workspace-name>"
CODER_WORKSPACE_ID="<unique-workspace-id>"
CODER_WORKSPACE_OWNER_NAME="<owner-username>"
```

## Environment Variable Flow

### From Workspace to Convex Backend
The Convex self-hosted backend receives workspace environment variables through this mapping:

```bash
# Database connectivity
DATABASE_URL="${PGURI}"
POSTGRES_URL="${PGURI}"

# S3 storage (currently disabled for local storage)
AWS_REGION="${S3_REGION}"
AWS_ACCESS_KEY_ID="${S3_ACCESS_KEY}" 
AWS_SECRET_ACCESS_KEY="${S3_SECRET_KEY}"
S3_STORAGE_EXPORTS_BUCKET="${S3_BUCKET_NAME}"
S3_STORAGE_SNAPSHOT_IMPORTS_BUCKET="${S3_BUCKET_NAME}"
S3_STORAGE_MODULES_BUCKET="${S3_BUCKET_NAME}"
S3_STORAGE_FILES_BUCKET="${S3_BUCKET_NAME}"
S3_STORAGE_SEARCH_BUCKET="${S3_BUCKET_NAME}"
S3_ENDPOINT_URL="${S3_ENDPOINT}"
```

### Frontend Environment Variables
```bash
# React/Vite environment (.env.local)
VITE_CONVEX_URL="http://localhost:3210"                    # Local backend
CONVEX_SELF_HOSTED_URL="<workspace-backend-url>"           # External access
CONVEX_SELF_HOSTED_ADMIN_KEY="<admin-key>"                 # Dashboard access
CONVEX_DASHBOARD_URL="<workspace-dashboard-url>"           # Dashboard access
CONVEX_PROXY_URL="<workspace-proxy-url>"                   # Proxy access
NEXT_PUBLIC_DEPLOYMENT_URL="<workspace-backend-url>"       # Dashboard config
```

## Current Configuration Status

### âœ… Working Configuration
- **Database**: PostgreSQL automatically connected via workspace credentials
- **Storage**: Local file storage (S3 disabled due to compatibility issues)
- **Backend**: Self-hosted Convex running on port 3210 with workspace integration
- **Dashboard**: Running on port 6791 with correct deployment URL configuration
- **Frontend**: Vite development server on port 5173

### ðŸ”§ Configuration Changes Made
1. **Dashboard URL Fix**: Added `env_file: - .env` to dashboard service in docker-compose
2. **Local Storage**: Disabled S3 configuration to use local file storage 
3. **Environment Cleanup**: Removed hardcoded workspace URLs from source code
4. **Variable Precedence**: Resolved conflicts between multiple .env files

## Troubleshooting Environment Issues

### Common Problems and Solutions

#### 1. Dashboard Shows Wrong URL
**Problem**: Dashboard displays `localhost:3210` instead of workspace URL
**Solution**: 
- Ensure dashboard service has `env_file: - .env` in docker-compose.yml
- Verify `NEXT_PUBLIC_DEPLOYMENT_URL` is set correctly in `.env`
- Remove conflicting values from `.env.docker`
- Restart dashboard service: `docker-compose restart dashboard`

#### 2. Database Connection Failures
**Problem**: Backend cannot connect to PostgreSQL
**Solution**:
- Verify workspace PostgreSQL is running
- Check that `PGURI` environment variable is properly injected
- Confirm backend container has access to database environment variables

#### 3. File Upload Issues  
**Problem**: File uploads fail with S3 errors
**Solution**:
- Current setup uses local storage (S3 disabled)
- For S3: verify bucket permissions and credentials
- For local: ensure Docker volume mounts are correct

#### 4. Environment Variable Precedence
**Problem**: Wrong values being used despite correct .env files
**Solution**:
- Check `environment:` section in docker-compose.yml (overrides env_file)
- Verify env_file directives are present for all services
- Restart services after environment changes

## Security Considerations

### Sensitive Information
- **Admin keys**: Should only be in environment variables, never hardcoded
- **Database passwords**: Auto-generated by workspace, rotated periodically  
- **S3 credentials**: Workspace-specific, isolated per workspace instance
- **Workspace URLs**: Should use environment variables, not hardcoded values

### Best Practices
- Use environment variables for all configuration
- Never commit secrets to version control
- Use generic placeholders in documentation
- Test configuration with clean environment variable loading

## Integration with Coder Template

This environment setup is automatically configured by the Convex Coder template which:
- Provisions PostgreSQL database with credentials injection
- Creates workspace-specific S3 buckets with unique access keys
- Sets up environment variable mapping between workspace and containers
- Configures port forwarding and service discovery
- Manages workspace-to-workspace cloning with data migration

For detailed template analysis, see `CONVEX_CODER_TEMPLATE_ANALYSIS.md`.