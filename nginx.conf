events {
    worker_connections 1024;
}

http {
    # DNS resolver for upstream server name resolution
    resolver 8.8.8.8 8.8.4.4 valid=30s;
    
    server {
        listen 9000;
        server_name localhost;

        # Proxy all S3 requests to Rook Ceph RGW
        location / {
            # Remove problematic headers that cause issues with Rook Ceph RGW
            proxy_set_header x-amz-server-side-encryption "";
            proxy_hide_header x-amz-server-side-encryption;
            
            # Forward other necessary headers
            proxy_set_header Host s3.us-central-1.hahomelabs.com;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header Content-Type $content_type;
            proxy_set_header Content-Length $content_length;
            proxy_set_header x-amz-content-sha256 $http_x_amz_content_sha256;
            proxy_set_header x-amz-date $http_x_amz_date;
            
            # Forward all other AMZ headers
            proxy_set_header x-amz-acl $http_x_amz_acl;
            proxy_set_header x-amz-storage-class $http_x_amz_storage_class;
            proxy_set_header x-amz-security-token $http_x_amz_security_token;
            
            # SSL Configuration for Rook Ceph RGW
            proxy_pass https://s3.us-central-1.hahomelabs.com;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            proxy_ssl_session_reuse off;
            proxy_http_version 1.1;
            
            # Connection settings
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering off;
            
            # Handle response headers
            proxy_pass_header Content-Type;
            proxy_pass_header Content-Length;
            proxy_pass_header ETag;
            proxy_pass_header x-amz-request-id;
            proxy_pass_header x-amz-version-id;
        }
    }
}