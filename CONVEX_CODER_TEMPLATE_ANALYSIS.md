# Convex Coder Template Implementation Analysis

## Overview
This document provides detailed implementation analysis of the Convex Coder workspace template, covering key architectural decisions, infrastructure setup, and practical usage patterns for Convex development in Coder workspaces.

## Template Architecture

### Core Infrastructure Components

#### 1. Workspace Container (main.tf)
- **Base Image**: `ghcr.io/coder/envbox:0.6.4` with Docker-in-Docker capability
- **Inner Image**: `harbor.hahomelabs.com/mycritters/devbox` (versioned via image-tag file)
- **Architecture**: x86_64 Linux (Ubuntu/Debian-based)
- **Resource Allocation**: 
  - Requests: 500m CPU, 4Gi memory
  - Configurable max CPU limit via `max_cpus` variable
- **Storage**: 30Gi persistent volume with subpath mounting for efficient cache separation

#### 2. Database Infrastructure (postgres.tf)
- **Database Engine**: PostgreSQL via Cloud Native PostgreSQL (CNPG) operator
- **Bootstrap Modes**:
  - `blank`: Fresh database initialization with consistent `app` database/owner
  - `workspace`: Clone from another workspace's backup with real-time data accuracy
- **Backup Strategy**: Automated S3-backed WAL and base backups with lifecycle management
- **Workspace-to-Workspace Cloning**: Pre-clone backup creation ensures latest data migration

#### 3. Storage Infrastructure (storage.tf)
- **Primary Storage**: Workspace-specific S3 bucket via ObjectBucketClaim on Rook Ceph
- **Backup Storage**: Separate S3 bucket for PostgreSQL backups with optimized lifecycle rules
- **Access Control**: `mycritters-reader` service account for cross-workspace data access
- **Capacity**: 5GB bucket limit with incomplete multipart upload cleanup

## Environment Variables & Configuration

### Workspace-Level Environment Variables
```bash
# Database Configuration (automatically injected)
PGHOST="<workspace-db-host>"
PGPORT="5432"
PGDATABASE="app" 
PGUSER="app"
PGPASSWORD="<auto-generated>"
PGURI="postgresql://app:<password>@<host>:5432/app"

# S3 Storage Configuration
S3_REGION="us-central-1"
S3_ENDPOINT="https://s3.us-central-1.hahomelabs.com"
S3_ACCESS_KEY="<workspace-specific>"
S3_SECRET_KEY="<workspace-specific>"
S3_BUCKET_NAME="workspace-<owner>-<name>-<short-id>"

# Workspace Identity
CODER_WORKSPACE_NAME="<workspace-name>"
CODER_WORKSPACE_ID="<workspace-id>"
CODER_WORKSPACE_OWNER_NAME="<owner-username>"
```

### Pre-configured Port Mappings
| Port | Service | Purpose | Access Level |
|------|---------|---------|--------------|
| 3000 | Next.js | Alternative dev server | Public |
| 3210 | Convex Backend | Self-hosted API | Public (hidden app) |
| 3211 | Convex Site Proxy | Backend proxy | Public (hidden app) |
| 5173 | Vite | Primary dev server | Public |
| 6791 | Convex Dashboard | Admin interface | Authenticated |
| 8080 | VS Code Web | Code editor | User-specific |
| 9323-9325 | Playwright | Testing tools | Authenticated |

## Development Workflow Integration

### Automatic Project Detection & Setup
The startup script (`app-startup.sh`) implements intelligent project detection:

#### Convex Project Detection
```bash
# Detection criteria (any of):
- convex.json file exists
- convex/ directory exists  
- "convex" dependency in package.json
```

#### Self-hosted vs Cloud Convex Detection
```bash
# Self-hosted indicators:
- docker-compose.yml exists
- .env.docker.example exists

# Cloud Convex indicators:
- No Docker Compose files
- Standard Convex cloud configuration
```

### Environment File Management
Automatic environment file creation from examples:
- `.env.local.example` → `.env.local` (frontend configuration)
- `.env.example` → `.env` (general configuration)
- `.env.docker.example` → `.env.docker` (backend services - **Note: This template doesn't handle this automatically**)

### Self-hosted Convex Integration
For self-hosted setups, the template automatically:

1. **Database Integration**: Injects workspace PostgreSQL credentials into Convex backend
2. **Storage Integration**: Configures all S3 buckets to use workspace-specific storage
3. **Service Orchestration**: Starts Docker Compose services with integrated credentials
4. **Admin Key Generation**: Attempts to generate admin keys for dashboard access
5. **Function Deployment**: Automatically deploys Convex functions on startup

### Environment Variable Mapping for Convex
```bash
# Workspace → Convex Environment Variable Mapping
DATABASE_URL="$PGURI"
POSTGRES_URL="$PGURI"
AWS_REGION="$S3_REGION"
AWS_ACCESS_KEY_ID="$S3_ACCESS_KEY"
AWS_SECRET_ACCESS_KEY="$S3_SECRET_KEY"
S3_STORAGE_EXPORTS_BUCKET="$S3_BUCKET_NAME"
S3_STORAGE_SNAPSHOT_IMPORTS_BUCKET="$S3_BUCKET_NAME"
S3_STORAGE_MODULES_BUCKET="$S3_BUCKET_NAME"
S3_STORAGE_FILES_BUCKET="$S3_BUCKET_NAME"
S3_STORAGE_SEARCH_BUCKET="$S3_BUCKET_NAME"
S3_ENDPOINT_URL="$S3_ENDPOINT"
```

## VS Code Configuration

### Pre-installed Extensions
Critical extensions for Convex development:
- **Convex-specific**: None explicitly listed (opportunity for improvement)
- **Development**: ESLint, Prettier, GitLens, Docker, Terraform
- **AI Assistance**: GitHub Copilot, Claude Code (version 2.0.6)
- **Testing**: Playwright extension

### Optimized Settings
```json
{
  "remote.portsAttributes": {
    "3000": { "onAutoForward": "silent" },  // Next.js
    "5173": { "onAutoForward": "silent" },  // Vite  
    "3210": { "onAutoForward": "silent" },  // Convex backend
    "3211": { "onAutoForward": "silent" },  // Convex proxy
    "6791": { "onAutoForward": "silent" },  // Convex dashboard
    "9323-9325": { "onAutoForward": "silent" }  // Playwright
  }
}
```

## Workspace-to-Workspace Cloning

### Implementation Details
The template supports sophisticated workspace cloning via:

1. **Pre-clone Backup Creation**: Triggers fresh backup of source workspace before cloning
2. **Backup Completion Waiting**: Kubernetes job waits for backup completion (timeout: 5 minutes)
3. **S3 Data Synchronization**: Script-based S3 bucket cloning using `mycritters-reader` credentials
4. **Database Recovery**: PostgreSQL recovery from latest WAL logs for real-time data accuracy

### Clone Source Options
- **`blank`**: Fresh workspace with empty database and S3 bucket
- **`workspace`**: Clone from another workspace (requires full workspace name: `username-workspacename-XXXXXXXX`)

## Key Implementation Insights

### Strengths
1. **Integrated Infrastructure**: Seamless PostgreSQL and S3 integration eliminates configuration complexity
2. **Automatic Detection**: Intelligent project type and configuration detection reduces manual setup
3. **Workspace Isolation**: Each workspace gets dedicated database and storage resources
4. **Cross-workspace Compatibility**: Sophisticated cloning mechanism enables workspace-to-workspace migration
5. **Development-Optimized**: Pre-configured ports, extensions, and development servers

### Areas for Enhancement

#### 1. Convex-Specific Improvements
- **Missing Convex VS Code Extension**: Template doesn't install official Convex extension
- **Convex CLI Version Management**: No pinned Convex CLI version
- **Dashboard URL Configuration**: Manual intervention required for proper dashboard URL setup (as evidenced by our recent work)

#### 2. Environment File Handling
```bash
# Current gap: .env.docker not automatically created from .env.docker.example
# Recommendation: Add to app-startup.sh
if [[ -f ".env.docker.example" ]] && [[ ! -f ".env.docker" ]]; then
    cp ".env.docker.example" ".env.docker"
    echo "✅ Created .env.docker from .env.docker.example"
fi
```

#### 3. Docker Compose Service Detection
```bash
# Enhanced service health checking
if docker compose ps | grep -q "backend.*healthy"; then
    echo "✅ Convex backend is healthy"
else
    echo "⚠️ Convex backend health check failed"
fi
```

## Practical Usage Patterns

### Common Commands for Convex Development
```bash
# Self-hosted Convex management
pnpm run docker:up           # Start with workspace integration
pnpm run docker:down         # Stop all services  
pnpm run docker:logs         # View service logs
pnpm run docker:generate-admin-key  # Generate dashboard key

# Development workflow
convex dev                   # Cloud development server
convex deploy               # Deploy to production
pnpm dev                    # Start frontend development server

# Database management
psql $PGURI                 # Direct database access
pg_dump $PGURI > backup.sql # Manual backup
```

### Debugging Common Issues

#### 1. Repository Clone Failures
- **Timeout**: 60-second timeout with detailed error messages
- **Authentication**: Requires GitHub external authentication for private repos
- **URL Format**: Handles both `.git` and non-`.git` repository URLs

#### 2. Service Startup Issues
- **Dependency Chain**: Backend must be healthy before dashboard starts
- **Environment Variables**: Verify S3 and database credentials injection
- **Port Conflicts**: Check for existing services on required ports

#### 3. Dashboard Configuration Issues
- **URL Mismatch**: Ensure `NEXT_PUBLIC_DEPLOYMENT_URL` uses workspace DNS, not localhost
- **Environment File Loading**: Verify docker-compose service has `env_file` directive
- **Admin Key**: Check if admin key generation completed successfully

## Integration Points

### Claude Code Integration
- **Version**: 2.0.6 with experimental task reporting
- **MCP Integration**: Configured with system prompts for workspace context
- **Credentials Sync**: Automated S3-based credential synchronization via cron job

### GitHub Integration
- **External Authentication**: Required for private repository access
- **Git Configuration**: Automatic user configuration via Coder modules
- **Repository Management**: GitHub CLI pre-installed for workflow automation

### Container Registry Integration
- **Harbor**: Uses `harbor.hahomelabs.com/mycritters/devbox` as inner image
- **Pull Secrets**: Automatic Docker registry authentication
- **Versioning**: Image tags managed via `image-tag` file

## Template Customization Recommendations

### Organization-Specific Enhancements
1. **Add Convex-specific VS Code extensions**:
   ```hcl
   extensions = concat(local.vscode.extensions, [
     "convex-dev.convex-vscode"  # If available
   ])
   ```

2. **Environment-specific defaults**:
   ```hcl
   # Add to coder_parameter blocks
   data "coder_parameter" "convex_environment" {
     name = "convex_environment"
     description = "Convex deployment environment"  
     default = "development"
     options = ["development", "staging", "production"]
   }
   ```

3. **Enhanced health monitoring**:
   ```bash
   # Add to startup script
   curl -f http://localhost:3210/version || echo "⚠️ Convex backend not responding"
   curl -f http://localhost:6791 || echo "⚠️ Convex dashboard not responding"
   ```

## Status: Template Analysis Complete ✅

This template provides a sophisticated, production-ready foundation for Convex development in Coder workspaces with automated infrastructure provisioning, intelligent project detection, and comprehensive development tool integration.